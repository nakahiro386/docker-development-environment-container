version: '2.2'

networks: {}

volumes: # {{{
  nginx-cache:
    driver: local
  nginx-pid:
    driver: local
  nginx-conf.d:
    driver: local
# }}}

services:

  &omgwtfssl omgwtfssl: # {{{
    extends:
      file: common.yml
      service: common
    image: paulczar/omgwtfssl
    hostname: *omgwtfssl
    read_only: true
    restart: "no"
    volumes:
      - ./certs:/certs
    environment:
      - CA_SUBJECT=${CA_SUBJECT:-test-ca}
      - CA_EXPIRE=${CA_EXPIRE:-60}
      - SSL_SUBJECT=${HOSTNAME}
      - SSL_DNS=${HOSTNAME}
      - SSL_EXPIRE=${SSL_EXPIRE:-60}
    # }}}

  &nginx nginx: # {{{
    extends:
      file: common.yml
      service: common
    image: nginx:stable-alpine
    hostname: *nginx
    read_only: true
    ports:
      - ${NGINX_PORT:-80}:${NGINX_PORT:-80}
      - ${NGINX_SSL_PORT:-443}:${NGINX_SSL_PORT:-443}
    environment:
      - NGINX_PORT=${NGINX_PORT:-80}
      - NGINX_SSL_PORT=${NGINX_SSL_PORT:-443}
    volumes:
      - nginx-cache:/var/cache/nginx
      - nginx-pid:/var/run
      - nginx-conf.d:/etc/nginx/conf.d
      - ./nginx/templates:/etc/nginx/templates:ro
      - ./certs:/etc/nginx/ssl:ro
      - ./nginx/html:/usr/share/nginx/html:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "-O", "/dev/null", 'http://127.0.0.1:${NGINX_PORT}/']
      retries: 10
    depends_on:
      - *omgwtfssl
  # }}}

# vim:set filetype=docker-compose expandtab shiftwidth=2 tabstop=2 foldmethod=marker:
